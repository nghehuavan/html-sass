<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>画像認証</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <div class="container">
    <div class="content">
      <div class="header">
        画像認証
      </div>
      <div class="upload-preview d-none" href="#" id="upload-preview">
        <img src="images/image1.png" alt="" id="image" height="317">
      </div>
      <a class="upload-box" href="#" id="upload-box">
        <div><img src="images/upload.png" alt=""></div>
        <div>顔画像をアップロード</div>
      </a>
      <form action="/facecheck" method="post" id="upload-form" class="d-none">
        <input accept="image/*" type="file" id="file-upload" />
        <button type="submit" id="submit"></button>
      </form>
      <div class="face-result error">顔を検出できませんでした</div>
      <div class="btn-container">
        <a href="javascript:reset()" class="btn-primary">リセット</a>
        <a href="/" class="btn-outline">ホームへ戻る</a>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    const form = document.getElementById("upload-form");
    const submit = document.getElementById("submit");
    const uploadPreview = document.getElementById("upload-preview");
    const uploadBox = document.getElementById("upload-box");
    const fileUpload = document.getElementById("file-upload");
    const image = document.getElementById("image");

    form.addEventListener('submit', handleSubmit);
    function handleSubmit(event) {
      event && event.preventDefault();
      const form = event.currentTarget;
      const url = new URL(form.action);
      const formData = new FormData(form);
      const searchParams = new URLSearchParams(formData);
      const fetchOptions = {
        method: form.method,
      };

      if (form.method.toLowerCase() === 'post') {
        if (form.enctype === 'multipart/form-data') {
          fetchOptions.body = formData;
        } else {
          fetchOptions.body = searchParams;
        }
      } else {
        url.search = searchParams;
      }

      fetch(url, fetchOptions);
    }

    fileUpload.onchange = evt => {
      const [file] = fileUpload.files
      if (file) {
        image.src = URL.createObjectURL(file)
        uploadPreview.classList.remove("d-none")
        uploadBox.classList.add("d-none")
        submit.click();
      }
    }

    uploadBox.addEventListener('click', (e) => {
      e.preventDefault();
      fileUpload.click();
    });

    function reset() {
      uploadPreview.classList.add("d-none")
      uploadBox.classList.remove("d-none")
      form.reset();
    }

  </script>
</body>

</html>